<!-- templates/timesheet/timesheet_formset.html -->
{% extends "mysite/site-base.html" %}

{% load static %}
{% load account %}
{% load i18n %}

{% block head_title %}{% trans "Timesheets" %}{% endblock %}

{% block content %}
<!-- Header -->
<div class="w3-container w3-margin-top">
  <header class="w3-black w3-opacity w3-padding-16">
    <h1 class="w3-margin">Your weekly timesheet</h1>
  </header>
  <br>
  <h2>Week starting: {{ week_start|date:"l, jS F Y." }}</h2>
  <div id="timesheet-forms">
    <!-- Existing forms with the class "timesheet-form" -->
    <div class="timesheet-form">
      <form method="POST" class="w3-card-4">
        {% csrf_token %}
        {{ formset.management_form }}
        {{ formset.non_form_errors.as_ul }}
        <table id="formset" class="w3-table">
          {% for form in formset.forms %}
            {% if forloop.first %}
              <thead><tr class="w3-topbar w3-bottombar w3-border-blue w3-pale-blue w3-text-blue">
                {% for field in form.visible_fields %}
                  <th>{{ field.label|capfirst }}</th>
                {% endfor %}
              </tr></thead>
            {% endif %}
            <tbody>
            <tr class="{% cycle row1 row2 %}">
              {% for field in form.visible_fields %}
                <td>
                  {# Include the hidden fields in the form #}
                  {% if forloop.first %}
                    {% for hidden in form.hidden_fields %}
                      {{ hidden }}
                    {% endfor %}
                  {% endif %}
                    {{ field.errors.as_ul }}
                    {{ field }}
                </td>
              {% endfor %}
            </tr>
          </tbody>
          {% endfor %}
          <tfoot>
            <tr id="totals" class="w3-topbar w3-bottombar w3-border-green w3-pale-green w3-text-green">
                <td><strong>Totals:</strong></td>
                <td><strong><span id="week-total">0</span></strong></td>
                <td><strong><span id="monday-total">{{ weekday_totals.0 }}</span></strong></td>
                <td><strong><span id="tuesday-total">{{ weekday_totals.1 }}</span></strong></td>
                <td><strong><span id="wednesday-total">{{ weekday_totals.2 }}</span></strong></td>
                <td><strong><span id="thursday-total">{{ weekday_totals.3 }}</span></strong></td>
                <td><strong><span id="friday-total">{{ weekday_totals.4 }}</span></strong></td>
                <td><strong><span id="saturday-total">{{ weekday_totals.5 }}</span></strong></td>
                <td><strong><span id="sunday-total">{{ weekday_totals.6 }}</span></strong></td>
                <td></td>
            </tr>
          </tfoot>
        </table>
      </form> 
    <br>
    <a href="{% url 'project:timesheet_list' %}" class="w3-btn w3-border w3-blue" type="button" id="back"><i class="fa fa-arrow-left" aria-hidden="true"></i> Back</a>
    <button class="w3-btn w3-border w3-green" type="button" id="add-more"><i class="fa fa-plus" aria-hidden="true"></i> Add</button>
    <button class="w3-btn w3-border w3-red" type="button"><i class="fa fa-trash" aria-hidden="true"></i> Delete</button>
    <button class="w3-btn w3-border w3-indigo" type="submit"><i class="fa fa-floppy-o" aria-hidden="true"></i> Save</button>
  {% comment %} <td><strong><span id=monday_total+tuesday_total+wednesday_total+thursday_total+friday_total+saturday_total+sunday_total {% endcomment %}
  </div>
</div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const weekdayMap = ["monday_hours", "tuesday_hours", "wednesday_hours", "thursday_hours", "friday_hours", "saturday_hours", "sunday_hours"];

    function updateTotals() {
        let weekTotal = 0;
        let dayTotals = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };

        // Loop over all form indices
        document.querySelectorAll('[id^="id_form-"]').forEach(input => {
            // Check if the input corresponds to a weekday field
            weekdayMap.forEach((day, index) => {
                if (input.id.endsWith(day)) {
                    const hours = parseFloat(input.value) || 0;
                    weekTotal += hours;
                    dayTotals[index] += hours;
                }
            });
        });

        // Update the weekly total
        const weekTotalElement = document.getElementById("week-total");
        if (weekTotalElement) {
            weekTotalElement.innerText = weekTotal.toFixed(2);
            weekTotalElement.style.color = weekTotal >= 24 ? "red" : "green";
        }

        // Update each weekday total and apply color coding
        weekdayMap.forEach((day, index) => {
            const dayTotalElement = document.getElementById(`${day.split('_')[0]}-total`);
            if (dayTotalElement) {
                dayTotalElement.innerText = dayTotals[index].toFixed(2);
                dayTotalElement.style.color = dayTotals[index] >= 24 ? "red" : "green";
            }
        });
    }

    // Attach event listeners to all weekday input fields
    document.querySelectorAll('[id^="id_form-"]').forEach(input => {
        if (weekdayMap.some(day => input.id.endsWith(day))) {
            input.addEventListener('input', updateTotals);
        }
    });

    // Run totals calculation on page load
    updateTotals();
});

</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const formContainer = document.getElementById("timesheet-forms");
    const addMoreButton = document.getElementById("add-more");
    const totalFormsInput = document.querySelector("form-TOTAL_FORMS");

    // Event listener for adding new form rows to the formset
    addMoreButton.addEventListener("click", function() {
        const currentFormCount = parseInt(totalFormsInput);
        const newFormCount = currentFormCount + 1;

        // Clone the last form element to use as a template
        const lastForm = formContainer.querySelector(".timesheet-form:last-child");
        const newForm = lastForm.cloneNode(true);

        // Update the form index in the cloned form's input fields
        newForm.querySelectorAll("input, select, label").forEach(element => {
            if (element.hasAttribute("id")) {
                element.id = element.id.replace(`id_form-${currentFormCount - 1}-`, `id_form-${currentFormCount}-`);
            }
            if (element.hasAttribute("name")) {
                element.name = element.name.replace(`form-${currentFormCount - 1}-`, `form-${currentFormCount}-`);
            }
            if (element.tagName === "INPUT") {
                element.value = "";  // Clear input values for the new form
            }
        });

        // Append the new form to the container
        formContainer.appendChild(newForm);
        totalFormsInput.value = newFormCount;  // Update TOTAL_FORMS count
    });

    function isFormEmpty(formIndex) {
        const hourFields = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day =>
            document.querySelector(`#id_form-${formIndex}-${day}_hours`)
        );

        return hourFields.every(field => !field || field.value === "" || field.value === "0");
    }

    function updateTotalDisplay(totalHours, elementId) {
        const element = document.getElementById(elementId);
        element.innerText = totalHours.toFixed(2);
        element.style.color = totalHours > 24 ? "red" : "black";
    }
  });
</script>
{% endblock %}
