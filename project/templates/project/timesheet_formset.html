<!-- templates/timesheet/timesheet_formset.html -->
{% extends "mysite/site-base.html" %}

{% load static %}
{% load account %}
{% load i18n %}

{% block head_title %}{% trans "Timesheets" %}{% endblock %}

{% block content %}
<!-- Header -->
<div class="w3-container w3-margin-top">
  <header class="w3-black w3-opacity w3-padding-16">
    <h1 class="w3-margin">Timesheets</h1>
  </header>
   
  <br>
  <h3>Timesheet for the week starting {{ week_start_date|date:"l, jS F Y." }}</h3>

  <!-- Navigation Arrows -->
  <a href="?week_offset={{ week_offset|add:-1 }}" class="w3-btn w3-red"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i>  Previous Week</a>
  <a href="?week_offset={{ week_offset|add:1 }}" class="w3-btn w3-red">Next Week  <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
  <br> <br>
  <div class="w3-card-4 w3-padding">
  <form method="POST">
    {% csrf_token %}
    {{ formset.management_form }}
    {{ formset.non_form_errors.as_ul }}
    <table id="formset" class="form">
      {% for form in formset.forms %}
        {% if forloop.first %}
          <thead><tr>
            {% for field in form.visible_fields %}
              <th>{{ field.label|capfirst }}</th>
            {% endfor %}
          </tr></thead>
        {% endif %}
        <tbody>
        <tr class="{% cycle row1 row2 %}">
          {% for field in form.visible_fields %}
            <td>
              {# Include the hidden fields in the form #}
              {% if forloop.first %}
                {% for hidden in form.hidden_fields %}
                  {{ hidden }}
                {% endfor %}
              {% endif %}
                {{ field.errors.as_ul }}
                {{ field }}
            </td>
          {% endfor %}
        </tr>
      </tbody>
      {% endfor %}
      <script>
        // Function to sum hours for each weekday
        function calculateTotals() {
            let mondayTotal = 0;
            let tuesdayTotal = 0;
            let wednesdayTotal = 0;
            let thursdayTotal = 0;
            let fridayTotal = 0;
    
        // Get the total number of forms
        const totalForms = document.getElementById('id_timesheet_set-TOTAL_FORMS').value;

        // Loop through each form in the formset
        for (let i = 0; i < totalForms; i++) {
            // Get the value for monday_hours, tuesday_hours, etc. for each form
            const mondayHours = parseFloat(document.getElementById(`id_timesheet_set-${i}-monday_hours`).value) || 0;
            const tuesdayHours = parseFloat(document.getElementById(`id_timesheet_set-${i}-tuesday_hours`).value) || 0;
            const wednesdayHours = parseFloat(document.getElementById(`id_timesheet_set-${i}-wednesday_hours`).value) || 0;
            const thursdayHours = parseFloat(document.getElementById(`id_timesheet_set-${i}-thursday_hours`).value) || 0;
            const fridayHours = parseFloat(document.getElementById(`id_timesheet_set-${i}-friday_hours`).value) || 0;

            // Add the hours to the respective totals
            mondayTotal += mondayHours;
            tuesdayTotal += tuesdayHours;
            wednesdayTotal += wednesdayHours;
            thursdayTotal += thursdayHours;
            fridayTotal += fridayHours;
        }

        // Helper function to update the total and change color based on value
        function updateTotalDisplay(dayTotal, elementId) {
          const element = document.getElementById(elementId);
          element.innerText = dayTotal.toFixed(2);

          // Set the color to red if the total exceeds 24 hours, otherwise set to black
          if (dayTotal > 24) {
              element.style.color = "red";
          } else {
              element.style.color = "black"; // or the default color
          }
        }

        // Update the totals in the DOM with the helper function
        updateTotalDisplay(mondayTotal, 'monday_total');
        updateTotalDisplay(tuesdayTotal, 'tuesday_total');
        updateTotalDisplay(wednesdayTotal, 'wednesday_total');
        updateTotalDisplay(thursdayTotal, 'thursday_total');
        updateTotalDisplay(fridayTotal, 'friday_total');
        }

        // Run the calculation function on page load
        window.onload = calculateTotals;

        // Add event listeners to all inputs to recalculate totals when values change
        document.querySelectorAll('input[type="number"]').forEach(function(input) {
            input.addEventListener('input', calculateTotals);
        });
      </script>
      <tfoot>
        <tr>
            <td> </td>
            <td class="w3-right-align"><strong>Subtotal Hours:</strong></td>
            <td class="w3-right-align"><strong><span id="monday_total">0</span></strong></td>
            <td class="w3-right-align"><strong><span id="tuesday_total">0</span></strong></td>
            <td class="w3-right-align"><strong><span id="wednesday_total">0</span></strong></td>
            <td class="w3-right-align"><strong><span id="thursday_total">0</span></strong></td>
            <td class="w3-right-align"><strong><span id="friday_total">0</span></strong></td>
        </tr>
      </tfoot>
    </table>
    <br>
    <button class="w3-btn w3-large w3-border w3-red" type="submit">Save</button>
  </form> 
</div>
</div>
  
{% endblock %}
